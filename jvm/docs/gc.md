本文摘自书籍[《深入理解Java虚拟机：JVM高级特性与最佳实践》](https://www.amazon.cn/dp/B00DA0E170/ref=sr_1_1_twi_kin_2?s=books&ie=UTF8&qid=1528283344&sr=1-1&keywords=%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA) 

## 垃圾收集

程序计数器、虚拟机栈、本地方法栈随线程而生，随线程而灭；栈中的栈帧随着方法的进入和退出而有条不紊的执行者出栈和入栈操作。每一个栈帧中分配多少内存基本上在类结构确定下来时就确定了。因此，在这几个区域的内存分配和回收都具备确定性，不需要考虑回收问题，因为方法结束或线程结束时，内存自然就跟随着回收了。而Java 堆和方法区这类共享内存区域则不一样，只有在程序运行期间才能知道创建那些对象，这部分内存的分配和回收是动态的，垃圾回收器关注的就是这部分内存。

### 对象死亡

堆中几乎存放着`Java `世界中所有的对象实例，垃圾收集器在对堆进行回收前，第一件事就是要确定这些对象哪些还活着，哪些已经死亡（不能再被任何途径使用的对象）。

#### 引用计数法

给对象添加一个引用计数器，每当一个地方引用时，计数器值加一；当引用失效时，计数器值减一；任何时刻计数器为零的对象就是不可能再被使用的。此算法在大部分情况下都是一个不错的选择，但是Java 语言没有选择引用计数法来管理内存，最主要的原因是它很难解决对象之间相互循环引用的问题。

#### 根搜索算法（GC Roots Tracing）

通过一系列名为`GC Roots`的对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为引用链，当一个对象到 `GC Roots`没有任何引用链时，则证明此对象是不可用的。`Java `语言中，可作为`GC Roots`的对象包括：

1）虚拟机栈中（栈帧中的本地变量表）引用的对象。

2）方法区中的类静态属性引用的对象。

3）方法区中的常量引用的对象。

4）本地方法栈中 `JNI`（Native方法）引用的对象。

#### 两次标记

如果对象在进行根搜索后发现没有与`GC Roots`相连的引用链，那它会被第一次标记并且进行一次筛选，筛选的条件是此对象是否有必要执行`finalize()`方法。当对象没有覆盖`finalize()`方法或该方法已经被调用过，虚拟机将这两种情况视为“没必要执行”。若对象被判定为有必要执行`finalize()`方法，那么这个对象将会被放置在一个名为`F-Queue`的队列中，并在由虚拟机自动创建的、低优先级的`Finalizer`线程中执行。但是虚拟机只会触发这个方法，而不承诺等待其运行结束，以此避免`finalize()`方法执行缓慢或死循环导致对象得不到回收。`finalize()`方法是对象逃脱死亡的最后机会，稍后GC 将对`F-Queue`中的对象进行第二次标记，如果对象在`finalize()`方法中成功拯救自己（引用链上的对象建立关联），则会将它移出即将回收的集合中。注意：任何一个对象的`finalize()`方法都只会被系统调用一次；避免使用`finalize()`方法来挽回将被回收的对象，因为它的运行代价高昂，不确定性大，也请不要使用它来做其它事情。

### 方法区 GC

方法区（`HotSpot `虚拟机中被称为永久代）垃圾回收性价比低，因为方法区中垃圾回收率不高，相比于 Java 堆新生代中收集率达70%~95%来说，确实收集代价相比下较高，但是在大量使用反射、动态代理、`CGLib`等`bytecode`框架的场景以及动态生成`JSP`和`OSGi`这类频繁自定义`ClassLoader`的情况下，卸载回收类这一方法区资源变得迫切，以保证永久代不会溢出。永久代收集的主要内容：

1）废弃常量

2）无用的类

#### 废弃常量

与回收Java 堆中对象类似，如常量池中含`abs`的字符串，但系统中无任何`String`对象为`abs`，那么这个字符串就应该被回收。常量池中的其它资源的回收与此类似。

#### 判定“无用的类”

判定一个常量是否为废弃常量比较简单，而判定类是否无用相对的难，“无用的类”应该同时满足三个条件：

1）该类所有实例都已经被回收，也就是`Java `堆中不存在该类的任何实例。

2）加载该类的`ClassLoader`被回收。

3）该类对应的`java.lang.Class`对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。

虚拟机可以对满足上诉条件的类进行回收，HotSpot 虚拟机中提供了`-Xnoclassgc`参数进行控制是否对类进行回收。还可以使用`-verbose:class`（Product版本虚拟机可用）、`-XX:+TraceClassLoading`（Product版本虚拟机可用）、`-XX：+TraceClassUnloading`（fastdebug版本虚拟机可用）查看类的加载和卸载信息。