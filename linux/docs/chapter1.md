## Linux 概述

![](images\1536636764929.png)

内核和用户进程之间最主要的区别是：内核在内核模式 （kernel mode）中运行，而用户进程则在 用户模式 （user mode）中运行。在内核模式中运行的代码可以不受限地访问中央处理器和内存，这种模式功能强大，但也非常危险，因为内核进程可以轻而易举地使整个系统崩溃。那些只有内核可以访问的空间我们称为内核空间。

相对于内核模式，用户模式对内存和中央处理器的访问有一定程度的限制，可访问的内存空间通常很小。对 CPU 的操作也很安全。用户空间指的是用户进程能够访问的内存空间。如果一个用户进程出错，其导致的后果相对有限，并且能够被内核清理掉。

理论上讲，一个用户进程出问题并不会对整个系统造成严重的影响。当然这取决于我们如何定义影响的严重性，并且还取决于该进程拥有的权限。因为不同进程拥有不同的权限，一些进程能够与执行一些特别的操作。



#### 理解主内存

主内存或许是所有硬件系统中最为重要的部分。主内存存储 0 和 1这样的数据。内核和进程就在主内存中运行，他们就是一些列比特的大合集。



#### 内核

内核的几乎所有操作都和主内存相关。其中之一是讲内存划分为很多区块，并且一直维护着这些区块的状态信息。每一个进程拥有自己的内存区块，且内核必须确保每个进程只使用自己的内存区块。内核负责管理一下四个方面：

- 进程：内核决定哪个进程可以使用 CPU。
- 内存：内核管理所有的内存，为进程分配内存，管理进程间的共享内存以及空闲空间。
- 设备驱动程序：作为硬件系统和进程之间的借口，内核负责操控硬件设备。
- 系统调用和支持：进程通常使用系统调用和内核进行通信。



#### 进程管理

涉及进程的启动、暂停、恢复和终止。进程轮流使用 CPU，每个进程使用一段时间后就暂停，然后用让另一个进程使用，依次轮流，时间单位是毫秒级。一个进程让出使用权给另一个进程成为上下文切换。

内核负责上下文切换，它包括以下能力或者职责：

1）CPU 为每个进程计时，到时即停止进程，并切换至内核模式，由内核接管 CPU 控制权。

2）内核记录下当前 CPU 和内存的状态信息，这些信息在恢复被停止的进程时非常重要。

3）内核执行上一个时间段内的任务。

4）内核准备执行下一个进程，从准备就绪的进程中选择一个执行。

5）内核为新进程准备 CPU 和内存。

6）内核将新进程执行的时间段通知 CPU。

7）内核将 CPU 切换至用户模式，将 CPU 控制权移交给新进程。



#### 内存管理

内核在上下文切换过程中管理内存，这是一项十分复杂的工作，因为内核要保证以下所有条件：

1）内核需要自己的专有内存空间，其他的用户进程无法访问。

2）每个用户进程有自己的专有内存空间。

3）一个进程不能访问另一个进程的专有内存空间。

4）用户进程之间可以共享内存。

5）用户进程的某些内存空间可以只读的。

6）通过使用磁盘交换，系统可以使用比实际内存容量更多的内存空间。

新型的 CPU 提供了 MMU，即内存管理单元，MMU 使用了一种叫做虚拟内存的内存访问机制，即进程不是直接访问内存的实际物理地址，而是通过内核使得进程看起来可以使用整个系统的内存。当进程访问内存的时候，MMU 截获访问请求，然后通过内存映射表将要访问的内存地址转换为实际的物理地址。内核需要初始化、维护和更新这个地址映射表。



#### 设备驱动程序和设备管理

对于设备来说，内核的角色比较简单，通常设备只能在内核模式中被访问，因为设备访问不当有可能会让系统崩溃。另一个原因是不同设备之间没有统一的编程接口，即使同类设备也如此。



#### 系统调用和系统支持

内核还对用户进程提供其他功能，如：系统调用为进程执行一些他们不擅长或无法完成的工作。打开、读和写文件这些都涉及系统调用。

fork 和 exec 这两个系统调用对于我们了解进程如何启动很重要：

- fork ： 当进程调用 fork 时，内核创建一个和该进程几乎一模一样的副本。
- exec： 当进程调用 exec(program) 时，内核启动 program 来替换当前进程。

出了 init 以外，Linux 中所有用户进程都是通过 fork 来启动的。出了创建现有进程的副本外，大多数情况下你还可以使用  exec 来启动新的进程。如：当你输入 ls 命令时，终端窗口中 shell 会调用 fork 创建一个 shell 的副本，然后该副本调用 exec(ls) 来运行 ls。

![1536645582430](images\1536645582430.png)

除了系统调用，内核还为用户进程提供其他很多功能，最为常见的是虚拟设备。虚拟设备对于用户进程而言是物理设备，但其实他们都是通过软件实现的。因此从技术来说，他们并不需要存在于内核中，但是实际上他们很多都存在于内核中。如：内核的随机数生成器这样的虚拟设备，如果用户进程来实现，难度要大得多。



#### 用户空间

内核分配给用户进程的内存我们称之为用户空间。因为一个进程简单说就是内存中的一个状态。用户空间也可以指所有用户进程占用的所有内存。

Linux 中大部分的操作都发生在用户空间中，虽然从内核的角度来说，所有进程都是一样的，但是实际上要他们执行的是不同的任务。相对于系统组件，用户进程位于一个基础服务层中，工具服务在中间，用户使用的应用程序在最上层。

用户组是指一组用户的集合。用户组的主要作用是允许一个用户同组内的其他用户共享文件权限。